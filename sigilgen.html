<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chaos Magic Sigil Generator</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" href="icons/icon-192.png">

<style>
body {
  font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
  margin: 50px auto;
  max-width: 1000px;
  background: #f7f7f7;
  color: #222;
  line-height: 1.6;
  padding: 0 20px;
}

h1 {
  text-align: center;
  margin-bottom: 30px;
  font-size: 2.4em;
}

p a {
  display: block;
  width: 100%;
  word-wrap: break-word;
  font-size: clamp(1em, 4vw, 1.5em);
  text-align: center;
  text-decoration: none;
  color: #1a0dab;
  margin-bottom: 25px;
}

#textBox {
  display: block;
  width: 90%;
  max-width: 900px;
  margin: 30px auto;
  padding: 30px;
  border: 2px solid #aaa;
  border-radius: 12px;
  font-size: 3em;
  line-height: 1.4em;
  min-height: 260px;
  resize: none;
  box-sizing: border-box;
  background: #fff;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
  transition: height 0.1s ease-out;
}

#gridContainer {
  margin-bottom: 30px;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.pair {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  background: #fff;
  padding: 16px 12px;
  border-radius: 10px;
  font-size: 28px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
}

.pair span {
  font-weight: bold;
  font-size: 28px;
  margin-bottom: 8px;
}

.pair input {
  width: 100%;
  font-size: 1.5em;
  min-height: 60px;
  text-align: left;
  border: 1px solid #bbb;
  border-radius: 8px;
  background: #fdfdfd;
  padding: 5px;
  box-sizing: border-box;
}

.pair input:focus {
  border-color: #4CAF50;
  box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
  outline: none;
}

button {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 14px 30px;
  border-radius: 10px;
  font-size: 18px;
  cursor: pointer;
  margin: 10px;
  transition: background 0.2s;
}

button:hover {
  background: #45a049;
}

.buttons {
  text-align: center;
  margin-top: 20px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

#resetBtn { background: #2196F3; }
#resetBtn:hover { background: #1c85d8; }

#copyBtn { background: #FF9800; }
#copyBtn:hover { background: #e68900; }

#saveFileBtn { background: #9C27B0; }
#saveFileBtn:hover { background: #7b1fa2; }

#loadFileBtn { background: #FF5722; }
#loadFileBtn:hover { background: #e64a19; }

#toggleModeBtn { background: #607D8B; }
#toggleModeBtn.active { background: #009688; }

/* Install button style */
#installBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  background: #FF9800;
  color: black;
  font-size: 16px;
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  display: none; /* hidden by default */
}
#installBtn:hover {
  background: #e68900;
}
</style>
</head>

<body>
<h1>Chaos Magic Sigil Generator</h1>
<p>
  <a href="https://github.com/alt-magick/Correspondence/" target="_blank">
    https://github.com/alt-magick/Correspondence/
  </a>
</p>

<div id="gridContainer">
  <div class="grid" id="mappingGrid"></div>
</div>

<div class="buttons">
  <button id="resetBtn">üîÑ Reset to Default</button>
  <button id="saveFileBtn">üíæ Save Psypher to File</button>
  <button id="loadFileBtn">üìÇ Load Psypher from File</button>
  <input type="file" id="fileInput" style="display:none;" accept=".json">
</div>

<div class="buttons">
  <button id="toggleModeBtn">üñãÔ∏è Mode: Normal Text</button>
</div>

<textarea id="textBox" autocomplete="off"></textarea>

<div class="buttons">
  <button id="encodeBtn">üîê Encode (Ctrl+E)</button>
  <button id="decodeBtn">üîì Decode (Ctrl+D)</button>
  <button id="copyBtn">üìã Copy (Ctrl+C)</button>
</div>

<!-- Manual install button -->
<button id="installBtn">üì≤ Install Psypher</button>

<script>
// ------------------- Cipher Code -------------------
const grid = document.getElementById('mappingGrid');
const textBox = document.getElementById('textBox');
const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
const fileInput = document.getElementById('fileInput');
const toggleBtn = document.getElementById('toggleModeBtn');
let cipherMode = false;

const defaultMapping = {
  A: '‚òâ', B: '‚óè', C: '‚òæ', D: '‚òΩ', E: '‚óã', F: '‚òø', G: '‚ôÄ', H: '‚ôÅ', I: '‚ôÇ', J: '‚ôÉ',
  K: '‚ôÑ', L: '‚ôÖ', M: '‚ôÜ', N: '‚ôá', O: '‚ôà', P: '‚ôâ', Q: '‚ôä', R: '‚ôã', S: '‚ôå', T: '‚ôç',
  U: '‚ôé', V: '‚ôè', W: '‚ôê', X: '‚ôë', Y: '‚ôí', Z: '‚ôì'
};

// Create mapping inputs
alphabet.forEach(letter => {
  const div = document.createElement('div');
  div.classList.add('pair');
  div.innerHTML = `<span>${letter}</span><input type="text" id="map_${letter}" placeholder="?">`;
  grid.appendChild(div);
});

function loadMapping(map = defaultMapping) {
  alphabet.forEach(letter => {
    document.getElementById(`map_${letter}`).value = map[letter] || '';
  });
}

function getMapping(reverse = false) {
  const map = {};
  alphabet.forEach(letter => {
    const val = document.getElementById(`map_${letter}`).value;
    if (val) reverse ? map[val] = letter : map[letter] = val;
  });
  return map;
}

function saveCipherToFile() {
  const map = getMapping(false);
  const blob = new Blob([JSON.stringify(map, null, 2)], { type: 'application/json' });
  let filename = prompt("Enter a name for your psypher file:", "psypher.json");
  if (!filename) return;
  if (!filename.toLowerCase().endsWith('.json')) filename += '.json';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function loadCipherFromFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const map = JSON.parse(e.target.result);
      loadMapping(map);
    } catch {
      alert("Invalid psypher file.");
    }
  };
  reader.readAsText(file);
}

function transformText(input, reverse = false) {
  const map = getMapping(reverse);
  if (reverse) {
    const symbols = Object.keys(map).sort((a, b) => b.length - a.length);
    let temp = input;
    let result = '';
    while (temp.length > 0) {
      const match = symbols.find(sym => temp.startsWith(sym));
      if (match) {
        result += map[match].toLowerCase();
        temp = temp.slice(match.length);
      } else {
        result += temp[0];
        temp = temp.slice(1);
      }
    }
    return result;
  } else {
    return input.split('').map(c => {
      const upper = c.toUpperCase();
      return alphabet.includes(upper) ? (map[upper] || upper) : c;
    }).join('');
  }
}

function autoResize() {
  textBox.style.height = 'auto';
  textBox.style.height = textBox.scrollHeight + 'px';
}

function copyToClipboard() {
  const start = textBox.selectionStart;
  const end = textBox.selectionEnd;
  const textToCopy = (start !== end) ? textBox.value.slice(start, end) : textBox.value;
  navigator.clipboard.writeText(textToCopy)
    .then(() => {
      const btn = document.getElementById('copyBtn');
      const old = btn.textContent;
      btn.textContent = '‚úÖ Copied!';
      setTimeout(() => btn.textContent = old, 1000);
    })
    .catch(err => console.error('Clipboard copy failed:', err));
}

function toggleCipherMode() {
  cipherMode = !cipherMode;
  if (cipherMode) {
    toggleBtn.classList.add('active');
    toggleBtn.textContent = "üñãÔ∏è Mode: Psypher Typing";
    textBox.setAttribute('autocomplete', 'off');
  } else {
    toggleBtn.classList.remove('active');
    toggleBtn.textContent = "üñãÔ∏è Mode: Normal Text";
    textBox.setAttribute('autocomplete', 'on');
  }
}

textBox.addEventListener('beforeinput', function (e) {
  if (!cipherMode) return;
  if (e.inputType === 'insertText' && e.data) {
    const char = e.data;
    const cipherChar = transformText(char, false);
    const start = this.selectionStart;
    const end = this.selectionEnd;
    const text = this.value;
    this.value = text.slice(0, start) + cipherChar + text.slice(end);
    this.selectionStart = this.selectionEnd = start + cipherChar.length;
    e.preventDefault();
    autoResize();
  }
});

document.getElementById('encodeBtn').addEventListener('click', () => {
  const start = textBox.selectionStart;
  const end = textBox.selectionEnd;
  const text = textBox.value;
  if (start !== end) {
    const selected = text.slice(start, end);
    const transformed = transformText(selected, false);
    textBox.value = text.slice(0, start) + transformed + text.slice(end);
    textBox.selectionStart = start;
    textBox.selectionEnd = start + transformed.length;
  } else {
    textBox.value = transformText(text, false);
  }
  autoResize();
});

document.getElementById('decodeBtn').addEventListener('click', () => {
  const start = textBox.selectionStart;
  const end = textBox.selectionEnd;
  const text = textBox.value;
  if (start !== end) {
    const selected = text.slice(start, end);
    const transformed = transformText(selected, true);
    textBox.value = text.slice(0, start) + transformed + text.slice(end);
    textBox.selectionStart = start;
    textBox.selectionEnd = start + transformed.length;
  } else {
    textBox.value = transformText(text, true);
  }
  autoResize();
});

document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && !e.shiftKey && !e.altKey) {
    const key = e.key.toLowerCase();
    if (key === 'e') { e.preventDefault(); document.getElementById('encodeBtn').click(); }
    if (key === 'd') { e.preventDefault(); document.getElementById('decodeBtn').click(); }
    if (key === 'c') { e.preventDefault(); copyToClipboard(); }
  }
});

document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
document.getElementById('resetBtn').addEventListener('click', () => loadMapping(defaultMapping));
document.getElementById('saveFileBtn').addEventListener('click', saveCipherToFile);
document.getElementById('loadFileBtn').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => e.target.files.length && loadCipherFromFile(e.target.files[0]));
toggleBtn.addEventListener('click', toggleCipherMode);

loadMapping();
autoResize();

// ------------------- Service Worker -------------------
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker Registered'))
    .catch(err => console.log('SW registration failed:', err));
}

// ------------------- Install Prompt -------------------
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'block';
});

installBtn.addEventListener('click', () => {
  installBtn.style.display = 'none';
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then((choice) => {
    deferredPrompt = null;
  });
});
</script>

</body>
</html>
